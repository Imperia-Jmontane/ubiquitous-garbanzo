@using System.Linq
@model IReadOnlyCollection<MyApp.Models.Home.RepositoryListItemViewModel>

<div data-repository-payload="true" data-count="@Model.Count">
    @if (!Model.Any())
    {
        <div class="mt-8 rounded-xl border border-dashed border-white/10 bg-black/30 p-6 text-sm text-gray-300" data-empty-state="true">
            No repositories have been cloned yet. Use the form above to add the first repository.
        </div>
    }
    else
    {
        <ul class="mt-8 space-y-4" data-repository-items="true">
            @foreach (MyApp.Models.Home.RepositoryListItemViewModel repository in Model)
            {
                <li class="rounded-xl border border-white/10 bg-black/40 p-6 text-sm text-gray-100" data-repository-item="true">
                    <details class="group" @(repository.HasBranches ? string.Empty : "open")>
                        <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                            <div>
                                <h3 class="text-lg font-semibold text-white">@repository.Name</h3>
                                <p class="mt-1 truncate text-xs text-gray-400">@repository.RepositoryPath</p>
                                @if (!string.IsNullOrWhiteSpace(repository.RemoteUrl))
                                {
                                    <p class="mt-1 text-xs text-indigo-200">@repository.RemoteUrl</p>
                                }
                                <div class="mt-3 flex flex-wrap gap-2 text-xs">
                                    @if (repository.HasUncommittedChanges)
                                    {
                                        <span class="inline-flex items-center gap-1 rounded-full border border-yellow-500/60 bg-yellow-500/15 px-3 py-1 font-medium text-yellow-200">
                                            <span class="size-1.5 rounded-full bg-yellow-400"></span>
                                            Uncommited Changes
                                        </span>
                                    }

                                    <span class="inline-flex items-center gap-1 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 font-medium text-emerald-200">
                                        <span class="size-1.5 rounded-full bg-emerald-400"></span>
                                        @repository.FetchStatusLabel
                                    </span>

                                    @if (!repository.HasRemote)
                                    {
                                        <span class="inline-flex items-center gap-1 rounded-full border border-red-500/50 bg-red-500/10 px-3 py-1 font-medium text-red-200">
                                            <span class="size-1.5 rounded-full bg-red-400"></span>
                                            No remote configured
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-medium text-gray-200">
                                    <span class="h-2 w-2 rounded-full bg-indigo-400"></span>
                                    @repository.Branches.Count branch@(repository.Branches.Count == 1 ? string.Empty : "es")
                                </span>
                                <div class="flex items-center gap-2" data-repository-command-group="true">
                                    <button type="button" class="rounded-full bg-indigo-500 p-1.5 text-white transition hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-repository-command="fetch" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" title="Fetch latest changes" aria-label="Fetch latest changes">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="size-5">
                                            <path d="M6 9A6 6 0 0 1 15.9 5.1L18 7.2" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M15 4h3.75V7.75" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M18 15a6 6 0 0 1-9.9 3.9L6 16.8" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M9 20H5.25V16.25" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </button>
                                    <button type="button" class="rounded-full bg-indigo-500 p-1.5 text-white transition hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-repository-command="pull" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" title="Pull latest changes" aria-label="Pull latest changes">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="size-5">
                                            <path d="M12 3.75v12.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M7.5 11.75 12 16.25l4.5-4.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M6 19.5h12" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </button>
                                    <button type="button" class="rounded-full bg-indigo-500 p-1.5 text-white transition hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-repository-command="push" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" title="Push local commits" aria-label="Push local commits">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="size-5">
                                            <path d="M12 20.25V7.75" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M7.5 12.25 12 7.75l4.5 4.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            <path d="M6 4.5h12" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </button>
                                </div>
                                <button type="button" class="inline-flex items-center gap-1 rounded-md border border-red-500/50 bg-red-500/10 px-3 py-1 text-xs font-semibold text-red-200 transition hover:bg-red-500/20 focus:outline-none focus:ring-2 focus:ring-red-400/70 focus:ring-offset-2 focus:ring-offset-gray-900" data-repository-delete="true" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-remote="@repository.RemoteUrl" data-repository-unsynced="@(repository.HasUnsyncedChanges ? "true" : "false")" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" data-repository-uncommitted="@(repository.HasUncommittedChanges ? "true" : "false")" data-repository-unpushed="@(repository.HasUnpushedCommits ? "true" : "false")">
                                    <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="size-4">
                                        <path fill-rule="evenodd" d="M7 2.75A1.75 1.75 0 0 1 8.75 1h2.5A1.75 1.75 0 0 1 13 2.75V3h3.25a.75.75 0 0 1 0 1.5h-.452l-.729 11.02A2.25 2.25 0 0 1 12.825 17.75H7.175a2.25 2.25 0 0 1-1.994-2.23L4.452 4.5H4a.75.75 0 0 1 0-1.5H7Zm1.5 0a.25.25 0 0 0-.25.25V3h3.5v-.25a.25.25 0 0 0-.25-.25h-3Zm4.599 12.495.684-10.745H6.217l.684 10.745a.75.75 0 0 0 .748.705h5.702a.75.75 0 0 0 .748-.705ZM8.75 7.75a.75.75 0 0 1 .75.75v5a.75.75 0 0 1-1.5 0v-5a.75.75 0 0 1 .75-.75Zm2.5 0a.75.75 0 0 1 .75.75v5a.75.75 0 0 1-1.5 0v-5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd"></path>
                                    </svg>
                                    Remove
                                </button>
                            </div>
                        </summary>
                        <div class="mt-4 space-y-3">
                            @if (!repository.HasBranches)
                            {
                                <p class="rounded-lg border border-dashed border-white/10 bg-black/40 px-4 py-3 text-xs text-gray-400">
                                    No local branches were found for this repository.
                                </p>
                            }
                            else
                            {
                                <ul class="grid gap-3 sm:grid-cols-2">
                                    @foreach (MyApp.Models.Home.RepositoryBranchViewModel branch in repository.Branches)
                                    {
                                        <li class="rounded-lg border border-white/10 bg-gray-900/60 px-4 py-3 text-xs text-gray-200">
                                            <div class="flex items-start justify-between gap-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="font-semibold text-white">@branch.Name</span>
                                                    @if (branch.IsCurrent)
                                                    {
                                                        <span class="rounded-full bg-indigo-500/20 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-widest text-indigo-200">Current</span>
                                                    }
                                                </div>
                                                <span class="text-gray-400">@branch.TrackingSummary</span>
                                            </div>
                                            @{
                                                bool showCommitButton = branch.IsCurrent && repository.HasUncommittedChanges;
                                                bool showPublishButton = !branch.HasUpstream && repository.HasRemote;
                                                bool showSwitchButton = !branch.IsCurrent;
                                                bool showDeleteBranchButton = !branch.IsCurrent;
                                            }

                                            @if (showCommitButton || showPublishButton || showSwitchButton || showDeleteBranchButton)
                                            {
                                                <div class="mt-3 flex justify-end">
                                                    <div class="flex flex-wrap justify-end gap-2">
                                                        @if (showSwitchButton)
                                                        {
                                                            <button type="button" class="inline-flex items-center gap-1 rounded-md border border-white/10 bg-white/5 px-3 py-1 font-semibold text-white transition hover:bg-white/15 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-repository-command="switchBranch" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-branch="@branch.Name" data-flow-linked-target="@(repository.HasRemote && branch.HasUpstream ? "true" : "false")" title="Switch to this branch" aria-label="Switch to branch @branch.Name">
                                                                Switch to branch
                                                            </button>
                                                        }

                                                        @if (showCommitButton)
                                                        {
                                                            <button type="button" class="inline-flex items-center gap-1 rounded-md bg-indigo-500 px-3 py-1 font-semibold text-white transition hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-repository-command="commit" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" title="Add and commit changes" aria-label="Add and commit changes">
                                                                Add &amp; Commit
                                                            </button>
                                                        }

                                                        @if (showPublishButton)
                                                        {
                                                            <button type="button" class="inline-flex items-center gap-1 rounded-md bg-indigo-500 px-3 py-1 font-semibold text-white transition hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500" data-repository-command="publishBranch" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" data-repository-branch="@branch.Name" title="Publish branch" aria-label="Publish branch">
                                                                Publish branch
                                                            </button>
                                                        }

                                                        @if (showDeleteBranchButton)
                                                        {
                                                            <button type="button" class="inline-flex items-center gap-1 rounded-md border border-red-500/50 bg-red-500/10 px-3 py-1 font-semibold text-red-200 transition hover:bg-red-500/20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500" data-branch-delete="true" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-remote="@repository.RemoteUrl" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")" data-repository-uncommitted="@(repository.HasUncommittedChanges ? "true" : "false")" data-branch-name="@branch.Name" data-branch-has-upstream="@(branch.HasUpstream ? "true" : "false")" data-branch-upstream-gone="@(branch.UpstreamGone ? "true" : "false")" data-branch-ahead="@branch.AheadCount">
                                                                Delete branch
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </li>
                                    }
                                </ul>
                            }

                            <div class="mt-6 rounded-lg border border-white/10 bg-black/40 p-4 text-xs text-gray-200" data-branch-search="true" data-repository-name="@repository.Name" data-repository-path="@repository.RepositoryPath" data-repository-has-remote="@(repository.HasRemote ? "true" : "false")">
                                <div class="flex items-center justify-between gap-2">
                                    <h4 class="text-sm font-semibold text-white">Search remote branches</h4>
                                    @if (repository.HasRemote)
                                    {
                                        <span class="inline-flex items-center gap-1 rounded-full border border-indigo-500/40 bg-indigo-500/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-widest text-indigo-200">
                                            origin
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-[10px] font-semibold uppercase tracking-widest text-red-300">No remote</span>
                                    }
                                </div>
                                <p class="mt-2 text-[11px] text-gray-400">
                                    @if (repository.HasRemote)
                                    {
                                        @:Type to find remote branches hosted on origin.
                                    }
                                    else
                                    {
                                        @:Configure a remote origin to search for remote branches.
                                    }
                                </p>
                                <div class="mt-3">
                                    <div class="relative">
                                        <input type="text" class="w-full rounded-md border border-white/10 bg-black/60 px-3 py-2 text-sm text-white placeholder:text-gray-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:cursor-not-allowed disabled:opacity-50" placeholder="Search remote branches" data-branch-search-input="true" @(repository.HasRemote ? string.Empty : "disabled") />
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="pointer-events-none absolute right-3 top-1/2 size-4 -translate-y-1/2 text-gray-500">
                                            <path d="m21 21-4.35-4.35m0 0a7 7 0 1 0-9.9-9.9 7 7 0 0 0 9.9 9.9Z" stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-3 hidden space-y-2" data-branch-search-results="true">
                                    <p class="text-[11px] text-gray-500" data-branch-search-empty="true">Start typing to search remote branches.</p>
                                    <p class="hidden text-[11px] text-red-300" data-branch-search-error="true"></p>
                                    <p class="hidden text-[11px] text-gray-400" data-branch-search-loading="true">Searching remote branches...</p>
                                    <ul class="hidden max-h-64 space-y-2 overflow-y-auto pr-1" data-branch-search-list="true"></ul>
                                </div>
                            </div>
                        </div>
                    </details>
                </li>
            }
        </ul>
    }
</div>
